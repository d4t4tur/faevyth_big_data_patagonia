---
title: "DNMyE - SINTA"
author:  "Dirección Nacional de Mercados y Estadística"
output:
  xaringan::moon_reader:
    seal: false
    css: "dnmye_theme.css"
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true
---

class:inverse, middle

background-image: url(https://tableros.yvera.tur.ar/recursos/logos_institucionales/escudo_mdtyd_blanco.png)
background-position: 95% 95%
background-size: 30%

# Big data para el Turismo

### #LaRutaNatural PATAGONIA

<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>

### Dirección Nacional de Mercados y Estadística<br>Subsecretaría de Desarrollo Estratégico




```{r, echo=FALSE, warning=FALSE}
library(xaringanExtra)
# LOGO COLOR EN PAGs INTERNAS
xaringanExtra::use_logo(image_url = "https://tableros.yvera.tur.ar/recursos/logos_institucionales/escudo_mdtyd_color.png", 
                        position = css_position(top = "1em", right = "1em"), 
                        height = "20%", width = "20%")
# BARRA DE PROGRESO DE PRESENTACION
xaringanExtra::use_progress_bar(color = comunicacion::dnmye_colores("cian"))
# LAPIZ 
xaringanExtra::use_scribble()
# EXPLORADOR DE SLIDES
xaringanExtra::use_tile_view()
# HABILITAR WEBCAM
xaringanExtra::use_webcam()
```


```{r dnmye_theme, include=FALSE, warning=FALSE, eval=TRUE}
library(xaringanthemer) #EVAL FALSE
library(comunicacion)
style_mono_light(outfile = "dnmye_theme.css", # CSS FILE
                 # FONTS
                  header_font_google = google_font('Encode Sans'),
                  text_font_google   = google_font('Roboto'),
                  code_font_google   = google_font('IBM Plex Mono'),
                 # COLORES 
                 base_color = dnmye_colores("cian"),
                 code_inline_color = dnmye_colores("rosa"), 
                 inverse_link_color = "#3B4449",
                 background_color = "#FFFFFF",
                 title_slide_background_image = "escudo_mintur_blanco.png", 
                 title_slide_background_position = "95% 5%", 
                 title_slide_background_size = "200px", footnote_color = "#3B4449", link_color = "3B4449",text_slide_number_font_size = "16px"
                  
                 )
```


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  # fig.width=9, fig.height=3.5, fig.retina=3,
  out.width = "100%", 
  cache = FALSE,
  echo = F,
  message = FALSE, 
  warning = FALSE,
  fig.show = TRUE,
  hiline = TRUE
)
```


```{css, echo=FALSE}
div.my-footer {
    background-color: white;
    position: absolute;
    bottom: 0px;
    left: 0px;
    height: 40px;
    width: 100%;
}
div.my-footer span {
    font-size: 16px;
    color: #3B4449;
    position: absolute;
    left: 15px;
    bottom: 6px;
}


```


---

layout: true

<div class="my-footer"><span>DIRECCIÓN NACIONAL DE MERCADOS Y ESTADÍSTICA <a href="https://yvera.tur.ar/sinta"> - <b>www.yvera.tur.ar/sinta</a></b></span></div> 

---

## Ejemplo: IFAs No Residentes:  

### Punto de partida 

1. **16,69 M** de registros con información diaria de latitud y longitud a 5 decimales y país de origen del dispositivo.

--

2. Actividad de **592.684** de dispositivos únicos, durante 12 meses (año prepandemia).

--

#### Procesamiento (Ejemplo IFAs)


1. Registros iniciales: **16,69 M**

--

2. Exclusión de registros posteriores a marzo 2020 y/o con  coordenadas fuera de Argentina.

--

3. Redondeo de las coordenadas a tres decimales de precisión.

--

4. Deduplicación de registros con igual coordenada y fecha (año-mes-día)

--

#### Datos resultantes

- Registros seleccionados: **6,44 M** de **373.287** IFAs únicos.

---


```{r graf ifas ext x pais,  message=FALSE, warning=FALSE, echo = FALSE, out.width="80%"}

library(tidyverse)
library(arrow)
library(comunicacion)
library(herramientas)
library(leaflet)
library(sf)

paises_nombres <- read_csv('https://gist.githubusercontent.com/brenes/1095110/raw/c8f208b03485ba28f97c500ab7271e8bce43b9c6/paises.csv')

renombrar_paises <- function(x) {
  left_join(x, paises_nombres %>% select(iso2, nombre), 
            by = c("HomeCountry" = "iso2")) %>% 
  select(pais = nombre, everything())
  }

# ifas_ext <- read_file_srv("DataDNMYE/big_data/receptivo/ifas_extranjeros_enarg.parquet")
# 
# n_ifas_pais <- ifas_ext %>% 
#   distinct(IFA, HomeCountry) %>% 
#   group_by(HomeCountry) %>% 
#   summarise(n = n())
# 
# write_rds(n_ifas_pais, 'entradas/n_ifas_pais.rds')

n_ifas_pais <- read_rds('entradas/n_ifas_pais.rds')

n_ifas_pais <- n_ifas_pais %>% 
  mutate(HomeCountry = fct_lump(HomeCountry,
                                n = 15, w = n, other_level = "Otros")) %>%
  group_by(HomeCountry) %>% 
  summarise(n = sum(n)) %>% 
  ungroup() 

n_ifas_pais <- renombrar_paises(n_ifas_pais)

n_ifas_pais <- n_ifas_pais %>% 
  mutate(pais = ifelse(HomeCountry == "Otros", "Otros paises", pais))

n_ifas_pais <- n_ifas_pais %>% 
  mutate(pais = fct_reorder(pais, n))

ggplot(n_ifas_pais) +
  geom_col(aes(pais, n, fill = pais),
           show.legend = F) +
  geom_text(aes(pais, n+log(n)/2, 
                 label = lbl_int(n)),
             hjust = -0.3) +
  scale_fill_dnmye() +
  scale_y_continuous(labels = lbl_int, expand = expansion(add = c(0, 25000))) +
  coord_flip() +
  labs(x = "", y = "IFAs Únicos") +
  theme_minimal() +
  theme(text = element_text(size = 20)) +
  ggimage::geom_flag(data = n_ifas_pais,
                     aes(x = pais, y = n+2*10^3*log(n/2)+2000,
                         image = HomeCountry))
```

---

### Herramienta de análisis: encontrando visitas a Rutas Naturales e imperdibles

```{r}



geo_ifas_ext_sample <- read_file_srv("big_data/presentacion/sample_ifas_receptivo.parquet")

# set.seed(45)

# geo_ifas_ext_sample <- geo_ifas_ext %>% 
#   slice_sample(n = 5000) 

geo_ifas_ext_sample <- renombrar_paises(geo_ifas_ext_sample)

geo_ifas_ext_sample <-  geo_ifas_ext_sample %>% 
  st_as_sf(coords = c("Lon", "Lat"), crs = 4326)


paispal <- colorFactor(dnmye_paletas()(length(unique(geo_ifas_ext_sample$HomeCountry))),
                       geo_ifas_ext_sample$HomeCountry)

geo_ifas_ext_sample %>% 
  leaflet() %>% 
  geoAr::addArgTiles() %>% 
  addCircles(#color = ~ paispal(HomeCountry), fillOpacity = 1,
             popup = ~ lapply(glue::glue("Fecha: {Date}<br>IFA: {substr(IFA,1,7)}...<br>País: {pais}"),
                              htmltools::HTML)) # %>% 
  # addLegend(pal = paispal, values = unique(geo_ifas_ext_sample$HomeCountry)[1:10], opacity = 1)
  


```

---

```{r}
rutas_naturales <- read_file_srv('big_data/presentacion/rutas_naturales.geojson')

rutas_naturales <- rutas_naturales %>% 
  group_by(name) %>% 
  mutate(geometry = st_union(geometry))

rnpal <- colorFactor(dnmye_paletas()(length(unique(rutas_naturales$name))),
                       rutas_naturales$name)

geo_ifas_ext_sample %>% 
  leaflet() %>% 
  geoAr::addArgTiles() %>% 
  addPolygons(data = rutas_naturales, fillColor = ~rnpal(name), weight = 0) %>% 
  addCircles(#color = ~ factpal(HomeCountry), fillOpacity = 1,
             popup = ~ lapply(glue::glue("Fecha: {Date}<br>IFA: {substr(IFA,1,7)}...<br>País: {pais}"),
                              htmltools::HTML))
  # addLegend(pal = factpal, values = unique(geo_ifas_ext_sample$HomeCountry)[1:10], opacity = 1) 

```

---

```{r}

patagonia_andina <-  rutas_naturales %>% filter(name == "Ruta de la Patagonia Andina")

ifas_ext_patagonia_andina <- geo_ifas_ext_sample %>% 
  st_filter(patagonia_andina)


ifas_ext_patagonia_andina %>% 
  leaflet() %>% 
  geoAr::addArgTiles() %>% 
  addPolygons(data = patagonia_andina, fillColor = ~rnpal(name), weight = 0) %>% 
  setView(lat = -41.137,lng =  -71.304, zoom = 5) %>% 
  addCircles(#color = ~ factpal(HomeCountry), fillOpacity = 1,
             popup = ~ lapply(glue::glue("Fecha: {Date}<br>IFA: {substr(IFA,1,7)}...<br>País: {pais}"),
                              htmltools::HTML))
  # addLegend(pal = factpal, values = unique(geo_ifas_ext_sample$HomeCountry)[1:10], opacity = 1) 

```

---

```{r}

imperdibles <- read_file_srv('big_data/presentacion/imperdibles.gpkg')

imperdibles_patagonia_andina <- imperdibles %>% 
  filter(ruta_natural == "Patagonia Andina")


ifas_ext_patagonia_andina %>% 
  leaflet() %>% 
  geoAr::addArgTiles() %>% 
  addPolygons(data = imperdibles_patagonia_andina, fillColor = "#F7941E", color = "#F7941E", popup = ~ lapply(glue::glue("{nombre_ppal}"),
                              htmltools::HTML)) %>% 
  setView(lat = -41.137,lng =  -71.304, zoom = 5) %>% 
  addCircles(#color = ~ factpal(HomeCountry), fillOpacity = 1,
             popup = ~ lapply(glue::glue("Fecha: {Date}<br>IFA: {substr(IFA,1,7)}...<br>País: {pais}"),
                              htmltools::HTML))
  # addLegend(pal = factpal, values = unique(geo_ifas_ext_sample$HomeCountry)[1:10], opacity = 1) 

```

